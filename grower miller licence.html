<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Application for Grower Miller Licence</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      background: #f5f9f5;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      border-radius: 8px;
    }
    h2 {
      color: #2c6e3c;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 5px;
      margin-top: 30px;
    }
    label {
      display: block;
      margin: 12px 0 5px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    textarea,
    input[type="date"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
      margin-bottom: 5px;
    }
    input[type="file"] {
      margin-top: 5px;
      padding: 8px;
      border: 1px dashed #4CAF50;
      border-radius: 6px;
      background-color: #f9f9f9;
      width: 100%;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .checkbox-group, .radio-group {
      display: flex;
      gap: 20px;
      margin: 10px 0;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      width: 100%;
      transition: background-color 0.3s;
      margin-top: 20px;
    }
    button:hover {
      background-color: #3e8e41;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .required {
      color: red;
    }
    .form-note {
      font-size: 14px;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }
    .success-message {
      display: none;
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
      text-align: center;
      font-weight: bold;
    }
    .error-message {
      display: none;
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
      text-align: center;
      font-weight: bold;
    }
    .address-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .signatory-group {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    .capacity-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .location-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    @media (max-width: 600px) {
      .address-group,
      .signatory-group,
      .capacity-group,
      .location-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>Application for Grower Miller Licence</h1>
  
  <div class="success-message" id="successMessage">
    Your application has been submitted successfully!
  </div>
  
  <div class="error-message" id="errorMessage">
    There was an error submitting your application. Please try again.
  </div>

  <form id="millerForm" action="submit_grower_miller.php" method="POST" enctype="multipart/form-data">
    <div class="section">
      <h2>1. Applicant Information</h2>
      
      <label>Name of Applicant: <span class="required">*</span></label>
      <input type="text" name="applicant_name" required>

      <label>Nature of Application: <span class="required">*</span></label>
      <div class="radio-group">
        <label><input type="radio" name="nature" value="new" required> New</label>
        <label><input type="radio" name="nature" value="renewal"> Renewal</label>
      </div>

      <div class="address-group">
        <div>
          <label>Postal Address: <span class="required">*</span></label>
          <input type="text" name="postal_address" required>
        </div>
        
        <div>
          <label>Postal Code: <span class="required">*</span></label>
          <input type="text" name="postal_code" required>
        </div>
        
        <div>
          <label>Email: <span class="required">*</span></label>
          <input type="email" name="email" required>
        </div>
        
        <div>
          <label>Mobile Number: <span class="required">*</span></label>
          <input type="tel" name="mobile_number" required>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>2. Location Details</h2>
      
      <div class="location-group">
        <div>
          <label>County: <span class="required">*</span></label>
          <input type="text" name="county" value="Nyeri" readonly>
        </div>
        
        <div>
          <label>Sub-County (Constituency): <span class="required">*</span></label>
          <select id="subCounty" name="sub_county" onchange="populateWards()" required>
            <option value="">-- Select Sub-County --</option>
            <option value="tetu">Tetu</option>
            <option value="kieni_east">Kieni East</option>
            <option value="kieni_west">Kieni West</option>
            <option value="mathira">Mathira</option>
            <option value="othaya">Othaya</option>
            <option value="mukurweini">Mukurweini</option>
            <option value="nyeri_town">Nyeri Town</option>
          </select>
        </div>
        
        <div>
          <label>Ward: <span class="required">*</span></label>
          <select id="ward" name="ward" required>
            <option value="">-- Select Ward --</option>
          </select>
        </div>
        
        <div>
          <label>Village/Road: <span class="required">*</span></label>
          <input type="text" name="village_road" required>
        </div>
        
        <div>
          <label>L.R. No. / Plot No.: <span class="required">*</span></label>
          <input type="text" name="plot_no" required>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>3. Company / Organization (if applicable)</h2>
      
      <label>Certificate of Incorporation/Registration:</label>
      <input type="file" name="certificate" accept="application/pdf">
      <div class="form-note">Upload PDF document only</div>
      
      <label>List of Directors/Officials:</label>
      <input type="file" name="directors_list" accept="application/pdf">
      <div class="form-note">Upload PDF document only</div>
    </div>

    <div class="section">
      <h2>4. Signatories</h2>
      
      <div class="signatory-group">
        <div>
          <label>Name 1:</label>
          <input type="text" name="signatory1_name">
        </div>
        
        <div>
          <label>Signature 1 (upload):</label>
          <input type="file" name="signatory1_signature" accept=".pdf,.jpg,.jpeg,.png">
        </div>
        
        <div>
          <label>Date:</label>
          <input type="date" name="signatory1_date">
        </div>
      </div>
      
      <div class="signatory-group">
        <div>
          <label>Name 2:</label>
          <input type="text" name="signatory2_name">
        </div>
        
        <div>
          <label>Signature 2 (upload):</label>
          <input type="file" name="signatory2_signature" accept=".pdf,.jpg,.jpeg,.png">
        </div>
        
        <div>
          <label>Date:</label>
          <input type="date" name="signatory2_date">
        </div>
      </div>
    </div>

    <div class="section">
      <h2>5. Milling Capacity</h2>
      
      <div class="capacity-group">
        <div>
          <label>Parchment (tonnes/hour):</label>
          <input type="number" name="parchment_capacity" step="0.1">
        </div>
        
        <div>
          <label>Buni (tonnes/hour):</label>
          <input type="number" name="buni_capacity" step="0.1">
        </div>
      </div>
    </div>

    <div class="section">
      <h2>6. Mill Certification</h2>
      
      <label>Mill Certification (if any):</label>
      <input type="text" name="mill_certification">
    </div>

    <div class="section">
      <h2>7. Purpose of Application</h2>
      
      <div class="checkbox-group">
        <label><input type="checkbox" name="purpose" value="milling"> Milling own coffee</label>
        <label><input type="checkbox" name="purpose" value="marketing"> Marketing own coffee</label>
        <label><input type="checkbox" name="purpose" value="roasting"> Roasting, grinding/packaging own coffee</label>
      </div>
    </div>

    <div class="section">
      <h2>8. Final Declaration</h2>
      
      <div class="signatory-group">
        <div>
          <label>Applicant Signature (upload):</label>
          <input type="file" name="applicant_signature" accept=".pdf,.jpg,.jpeg,.png">
        </div>
        
        <div>
          <label>Date: <span class="required">*</span></label>
          <input type="date" name="final_date" required>
        </div>
        
        <div>
          <label>Stamp (upload):</label>
          <input type="file" name="applicant_stamp" accept=".pdf,.jpg,.jpeg,.png">
        </div>
      </div>
    </div>

    <button type="submit">Submit Application</button>
  </form>

  <script>
    // Ward data for Nyeri County based on IEBC boundaries
    const wardsBySubCounty = {
      tetu: [
        "DEDAN KIMANTHI",
        "WAMAGANA",
        "AGUTHI-GAAKI"
      ],
      kieni_east: [
        "NAROMORU KIAMATHAGA",
        "THEGU RIVER",
        "KABARU",
        "GAKAWA"
      ],
      kieni_west: [
        "MWEIGA",
        "MWIYOGO/ENDARASHA",
        "MUGUNDA",
        "GATARAKWA",
        "THEGU RIVER",
        "KABARU",
        "GAKAWA"
      ],
      mathira: [
        "RUGURU",
        "MAGUTU",
        "IRIAINI",
        "KONYU",
        "KIRIMUKUYU",
        "KARATINA TOWN"
      ],
      othaya: [
        "MAHIGA",
        "IRIA-INI",
        "CHINGA",
        "KARIMA"
      ],
      mukurweini: [
        "GIKONDI",
        "RUGI",
        "MUKURWE-INI WEST",
        "MUKURWE-INI CENTRAL"
      ],
      nyeri_town: [
        "KIGANJO/MATHARI",
        "RWARE",
        "GATITU/MURUGURU",
        "RURING'U",
        "KAMAKWA/MUKARO"
      ]
    };

    function populateWards() {
      const sc = document.getElementById('subCounty').value;
      const wardSelect = document.getElementById('ward');

      // reset
      wardSelect.innerHTML = '<option value="">-- Select Ward --</option>';

      if (!sc) return;

      const list = wardsBySubCounty[sc];
      if (!list) return;

      list.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = w;
        wardSelect.appendChild(opt);
      });
    }

    // Set today's date as default for all date fields
    function setDefaultDates() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayFormatted = `${year}-${month}-${day}`;
      
      // Set default for all date fields
      const dateInputs = document.querySelectorAll('input[type="date"]');
      dateInputs.forEach(input => {
        input.value = todayFormatted;
      });
    }

    // Enhanced form submission handling with AJAX
document.getElementById("formId").addEventListener("submit", async function(event) {
    event.preventDefault();
    
    console.log("Form submission started...");

    // Show loading state
    const submitBtn = document.getElementById('submitButton') || this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    submitBtn.disabled = true;

    // Hide previous messages
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';

    try {
        const formData = new FormData(this);
        console.log("Sending form data to server...");
        
        const response = await fetch('submit_handler.php', { // Replace with actual handler
            method: 'POST',
            body: formData
        });
        
        console.log("Response status:", response.status);
        const result = await response.json();
        console.log("Server response:", result);
        
        if (result.success) {
            console.log("Submission successful!");
            
            // Show success message
            const successMessage = document.getElementById('successMessage');
            successMessage.innerHTML = 
                `Your application has been submitted successfully!<br>
                 Reference Number: <strong>${result.ref_number}</strong><br>
                 Application ID: ${result.application_id}`;
            successMessage.style.display = 'block';
            
            // Reset form
            this.reset();
            setDefaultDates(); // If you have this function
            
            console.log("Form reset, redirecting in 3 seconds...");
            
            // Redirect after 3 seconds
            setTimeout(() => {
                window.location.href = 'track.html';
            }, 3000);
            
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error("Submission error:", error);
        document.getElementById('errorMessage').textContent = 
            'Error: ' + error.message;
        document.getElementById('errorMessage').style.display = 'block';
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

    // Initialize default dates on page load
    window.onload = setDefaultDates;
  </script>
</body>
</html>